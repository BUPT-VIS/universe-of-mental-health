<!DOCTYPE html>
<html>
<head>
<title>FUCK</title>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/p5@0.10.2/lib/p5.min.js"></script>
<script type="text/javascript" src="https://d3js.org/d3.v5.min.js"></script>

</head>
<body>
<script>

let data = {}, posData = [], wheelScale = 1, R = 0.8, r, size = 0.8, drag = false;

function preload() {
    data = loadJSON("angeli.json");
}

function setup() {
    console.log(typeof(data), data);

    var xScale = windowWidth/(80*2);
    var yScale = windowHeight/(40*2);

    // process data
    for (let i in data) {
    //if (i < 100) {
        posData.push({
            // 画面中心坐标 +- 比例尺
            'x': windowWidth/2 + xScale*data[i].x,
            'y': windowHeight/2 + yScale*data[i].y,
            'ox': 0,
            'oy': 0,
            'condition': split(data[i]['If so, what condition(s) were you diagnosed with?'], '|'),
            'view': data[i]['Do you think that team members/co-workers would view you more negatively if they knew you suffered from a mental health issue?']
        })
    }
    //console.log(posData);

    // create window
    createCanvas(windowWidth, windowHeight);
}

function draw() {
    background(0,0,0);

    var t = millis()/1000;

    posData.forEach((pos, i) => {
        // 计算明度
        var brightness = 70 + 5*pos.condition.length;

        // 计算小圆半径 星环半径
        var r = 0, ring = 0;
        if (pos.view == "Yes, they do") {
            r = size * (pos.condition.length*Math.abs(sin(6*t)) + 2);
        } else if (pos.view == "Yes, I think they would") {
            r = size * (pos.condition.length*Math.abs(sin(6*t)) + 2);
        } else if (pos.view == "Maybe") {
            r = size * (pos.condition.length*Math.abs(sin(6*t)) + 2);
        } else if (pos.view == "No, I don't think they would") {
            r = size * (pos.condition.length + 2);
            ring = 10 * size;
        } else if (pos.view == "No, they do not") {
            r = size * (pos.condition.length + 2);
            ring = 5 * size;
        }

        // 星环
        push();
        stroke(255, brightness);
        strokeWeight(size/2);
        noFill();
        if (ring > 0)  ellipse(pos.x, pos.y, ring, ring);
        pop();

        // 病情
        var dx, dy; // 小圆偏移
        pos.condition.forEach((condition, j) => {
            // 没病的人或一种病 无偏移
            if (pos.condition.length == 1) {
                dx = 0; dy = 0;
            }
            // 多于一种病 有偏移
            else {
                dx = R * sin(j * TWO_PI / pos.condition.length);
                dy = R * cos(j * TWO_PI / pos.condition.length);
            }                

            push();
            colorMode(HSB, 360, 100, 100, 100); //色相 饱和度 明度 透明度
            //fill(240, 1, brightness, brightness / 10); 
            blendMode(LIGHTEST); //加色混合

            if (condition == 'Mood Disorder (Depression, Bipolar Disorder, etc)') {
                fill(354.24, 354.24, brightness);
            } else if (condition == 'Anxiety Disorder (Generalized, Social, Phobia, etc)') {
                fill(285.47, 78.84, brightness);
            } else if (condition == 'Attention Deficit Hyperactivity Disorder') {
                fill(253.71, 80.41, brightness);
            } else if (condition == 'Post-traumatic Stress Disorder') {
                fill(230.61, 73.06, brightness);
            } else if (condition == 'Obsessive-Compulsive Disorder') {
                fill(220.66, 74.09, brightness);
            } else if (condition == 'Substance Use Disorder') {
                fill(190.54, 58.73, brightness);
            } else if (condition == 'Personality Disorder (Borderline, Antisocial, Paranoid, etc)') {
                fill(157.82, 51.97, brightness);
            } else if (condition == 'Stress Response Syndromes') {
                fill(132.4, 53.54, brightness);
            } else if (condition == 'Addictive Disorder') {
                fill(93.29, 68.92, brightness);
            } else if (condition == 'Eating Disorder (Anorexia, Bulimia, etc)') {
                fill(53.76, 68.65, brightness);
            } else if (condition == 'Dissociative Disorder') {
                fill(30.65, 77.18, brightness);
            } else if (condition == 'Psychotic Disorder (Schizophrenia, Schizoaffective, etc)') {
                fill(12.24, 83.4, brightness);
            } else if (condition == '') {
                fill(255, 40);
                noStroke();
            } else {
                fill(100, 100, brightness);
            }

            ellipse(pos.x + dx, pos.y + dy, r, r);
            pop();
        })
    })
}

function mousePressed() {
    if (mouseButton == LEFT) {
        drag = true;
        // 偏移量 = 鼠标位置 - 元素位置
        posData.forEach((pos, i) => {
            pos.ox = mouseX - pos.x;
            pos.oy = mouseY - pos.y;
        })
        return false;
    }
    return false;
}

function mouseDragged() {
    if (drag) {
        // 元素位置 = 鼠标位置 - 偏移量
        posData.forEach((pos, i) => {
            pos.x = mouseX - pos.ox;
            pos.y = mouseY - pos.oy;
        })
    }
}

function mouseReleased() {
    drag = false;
}

// 滚轮改变缩放没有过渡效果，但触控板连续变化
function mouseWheel(event) {
    // delta = 125 滚动一格的默认高度值，wheelScale 缩放比率
    if (event.delta < 0) {
        wheelScale = Math.abs(event.delta)/100; // 上滚放大
        R *= (1*wheelScale); // 错位感
    } else {
        wheelScale = 100/Math.abs(event.delta); // 下滚缩小 取倒数
        R *= (wheelScale/1); // 错位感
    }
    // 大小按照比例缩放
    size *= wheelScale;
    console.log(wheelScale, R);
    
    posData.forEach((pos, i) => {
        // 偏移量 = 缩放比率 * (元素位置 - 画面中心)
        pos.ox = wheelScale * (pos.x - windowWidth/2);
        pos.oy = wheelScale * (pos.y - windowHeight/2);

        // 画面中心 + 偏移量 = 元素位置
        pos.x = windowWidth/2 + pos.ox;
        pos.y = windowHeight/2 + pos.oy;
    })

    // 禁用浏览器默认滚动
    return false;
}

// // 触控板有时会失控 应该禁用 还未解决
// function touchStarted() {
//     return false;
// }
// function touchMoved() {
//     return false;
// }
// function touchEnded() {
//     return false;
// }
</script>
</body>
</html>