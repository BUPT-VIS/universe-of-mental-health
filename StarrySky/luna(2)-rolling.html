<!DOCTYPE html>
<html>
<head>
<title>FUCK</title>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/p5@0.10.2/lib/p5.min.js"></script>
<script type="text/javascript" src="https://d3js.org/d3.v5.min.js"></script>

</head>
<body>
<script>

let data = {}, posData = [], wheelScale = 1, radius = 3, size = 6, drag = false;

function preload() {
    data = loadJSON("2016(1).json");
}

function setup() {
    console.log(typeof(data), data);

    var xScale = windowWidth/(170*2);
    var yScale = windowHeight/(170*2);

    // process data
    for (let i in data) {
    if (i < 100) {
        posData.push({
            // 画面中心坐标 +- 比例尺
            'x': windowWidth/2 + xScale*data[i].x,
            'y': windowHeight/2 + yScale*data[i].y,
            'ox': 0,
            'oy': 0,
            'condition': split(data[i]['If so, what condition(s) were you diagnosed with?'], '|')
        })
    }
    }
    console.log(posData);

    // create window
    createCanvas(windowWidth, windowHeight);
}

function draw() {
    background(0,0,0);
    posData.forEach((pos, i) => {
        /*push();
        fill('yellow'); 
        ellipse(pos.x, pos.y, 6, 6);
        pop();*/

        //if (pos.condition.length == 1) {
            
        //} else {
            var B;

            if (pos.condition.length > 5)  B = 200;
            else B = 70 + 5*pos.condition.length;
            //console.log(B);
            //console.log(pos.condition.length)
            pos.condition.forEach((condition, j) => {
                var dx = radius * sin(j * TWO_PI / pos.condition.length);
                var dy = radius * cos(j * TWO_PI / pos.condition.length);

                push();
                colorMode(HSB, 360, 100, 100, 100); //色相 饱和度 明度 透明度
                fill(240, 1, B, B / 10); 
                blendMode(LIGHTEST); //加色混合
                if (condition == 'Mood Disorder (Depression, Bipolar Disorder, etc)') {
                    fill(5, 100, B);
                }
                else if (condition == 'Anxiety Disorder (Generalized, Social, Phobia, etc)') {
                    fill(30, 100, B);
                }
                else if (condition == 'Attention Deficit Hyperactivity Disorder') {
                    fill(60, 100, B);
                }
                else if (condition == 'Post-traumatic Stress Disorder') {
                    fill(28,100,B);
                }
                ellipse(pos.x + dx, pos.y + dy, size, size);
                pop();
            })
        //}
        
    })
}

function mousePressed() {
    if (mouseButton == RIGHT) {
        drag = true;
        // 偏移量 = 鼠标位置 - 元素位置
        posData.forEach((pos, i) => {
            pos.ox = mouseX - pos.x;
            pos.oy = mouseY - pos.y;
        })
        return false;
    }
    return false;
}

function mouseDragged() {
    if (drag) {
        // 元素位置 = 鼠标位置 - 偏移量
        posData.forEach((pos, i) => {
            pos.x = mouseX - pos.ox;
            pos.y = mouseY - pos.oy;
        })
    }
}

function mouseReleased() {
    drag = false;
}

// 滚轮改变缩放没有过渡效果，但触控板连续变化
function mouseWheel(event) {
    // delta = 125 滚动一格的默认高度值，wheelScale 缩放比率
    if (event.delta < 0) {
        wheelScale = Math.abs(event.delta)/100; // 上滚放大
        radius *= (1*wheelScale); // 错位感
    } else {
        wheelScale = 100/Math.abs(event.delta); // 下滚缩小 取倒数
        radius *= (wheelScale/1); // 错位感
    }
    // 大小按照比例缩放
    size *= wheelScale;
    console.log(wheelScale, radius);
    
    posData.forEach((pos, i) => {
        // 偏移量 = 缩放比率 * (元素位置 - 画面中心)
        pos.ox = wheelScale * (pos.x - windowWidth/2);
        pos.oy = wheelScale * (pos.y - windowHeight/2);

        // 画面中心 + 偏移量 = 元素位置
        pos.x = windowWidth/2 + pos.ox;
        pos.y = windowHeight/2 + pos.oy;
    })

    // 禁用浏览器默认滚动
    return false;
}

// 触控板有时会失控 应该禁用 还未解决
function touchStarted() {
    return false;
}
function touchMoved() {
    return false;
}
function touchEnded() {
    return false;
}
</script>
</body>
</html>